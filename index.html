<!DOCTYPE html>
<html>
<head>
<title>JQuery quiz</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="https://raw.github.com/freddiefujiwara/jquery-localStorage/master/jquery.localStorage.js"></script>
<!-- TODO confirm permission to use, under apache license -->
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript" src="calculation.js"></script>
<script type="text/javascript">
MathJax.Hub.Config({
  config: ["MMLorHTML.js"],
  jax: ["input/MathML","output/HTML-CSS","output/NativeMML"],
  extensions: ["mml2jax.js","MathMenu.js","MathZoom.js"]
});

var app = {
	wait_seconds: 3,
	questions: [],
	position: 0,
	start: null,
	render: function(form) {
		if (!app.start) {
			return;
		}

		if (app.nextQuestionTime() > new Date()) {
			/** @todo Pretty Pictures */
			form.innerHTML = 'You need to wait until ' + app.nextQuestionTime() + " to continue";
			return;
		}

		if (app.position < app.questions.length) {
			/** @todo remove all children */
			form.innerHTML = '';

			var q, h4, input, p;

			q = app.questions[app.position];

			h4 = document.createElement('h3');
			h4.appendChild(document.createTextNode(q.label));

			p = document.createElement('h2');
			p.appendChild(
				document.createTextNode(
					"Question " + (app.position+1) + " of " +app.questions.length
				)
			);

			form.appendChild(p);
			form.appendChild(h4);


			input = document.createElement("textarea");
			input.className = 'question';
			input.id = 'question[' + app.position + ']';
			input.name = 'question[' + app.position + ']';
			input.required = "required";

			input.onchange = function() { 
				try {
					if (this.value == '') {
						throw "No input";
					}

					var yours = this.value + "; " + q.equation;
					var mine = q.correct_answer + "; " + q.equation;

					app.log("Does `" + yours + "` equal `" + mine + "` ?");
					if (q.solve(yours) === q.solve(mine)) {
						app.log("Correct answer");
						app.next(form);
					} else {
						app.log("Incorrect answer");
						app.warn();
					}
				} catch (e) {
					app.log(e);
					app.warn();
				}
			};

			form.appendChild(input);
		}

		if (app.position >= app.questions.length) {
			/** @todo make prettier */
			form.innerHTML = "You win! All questions answered.";
		}
	},
	log: function(text) {
		if (window.console) {
			console.log(text)
		}
	},
	next: function(form) {
		$('.question').removeClass('wrong');
		$('.question').addClass('correct');
		app.position++;
		app.save();

		app.render(form);
	},
	warn: function() {
		$('.question').removeClass('correct');
		$('.question').addClass('wrong');
	},
	save: function() {
		$.localStorage.set("position", app.position, 5*60*1000);
		$.localStorage.set("start", app.start, 5*60*1000);
	},
	load: function() {
		var position = $.localStorage.get("position");
		if (position) {
			app.position = position;
		}
		var start = $.localStorage.get("start");
		if (start) {
			app.start = new Date(start);
		}
	},
	nextQuestionTime: function() {
		var wait_period = (app.wait_seconds * 1000);
		var offset = app.position * a_minute;

		return new Date(app.start.getTime() + offset);
	},
	init: function(form) {
		app.start = new Date(Date.now()); 
		app.save();

		app.render(form);
	},
	reset: function() {
		app.start = null;
		app.position = 0;
		app.save();
	}
};

var Question = function(label, equation, correct_answer) {
	this.log = function(text) {
		if (window.console) {
			console.log(text)
		}
	};

	this.label = label;
	this.equation = equation;
	this.correct_answer = correct_answer;

	this.solve = function(input_equation) {
		var math = mathjs(input_equation);
		var result = eval(math);

		this.log(input_equation + " translates to " + math);
		this.log(math + " evaluates to " + result);

		return eval(math);
	};
};

q = new Question(
	'When `a * b = 30, a = 5`, solve for `b`',
	'a = 5; a * b == 30;',
	"b = 6"
);

app.questions.push(q);

q = new Question(
	'When `a * b = 30, a = 6`, solve for `b`',
	'a = 6; a * b == 30;',
	"b = 5"
);

app.questions.push(q);

q = new Question(
	'When `cow * donkey = -1; donkey + sheep = 2; sheep = 3`, solve for `cow`, `donkey`',
	'cow * donkey == -1; sheep = 3; donkey + sheep == 2',
	"cow = 1; donkey = -1"
);


app.questions.push(q);

</script>
<style type="text/css">
.wrong {
	border: 1px solid red;
	color: red;
}

.wrong {
	border: 1px solid green;
	color: green;
}
</style>
</head>
<body>
	<h1>JQuery quiz</h1>
	<p>Note, answers are in <a href="http://www1.chapman.edu/~jipsen/mathml/asciimath.html">AsciiMath</a>.</p>
	<form id="questions">
		<a href="#questions" onclick="app.init($('#questions')[0]); return false">Ready?</a>
	</form>
<script type="text/javascript">
try {
	app.load();
} catch (e) {
	app.log(e);
}
app.render($('#questions')[0]);


/** @todo Fix rendering ? */
//MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
</script>
</body>
</html>
